---
- name: Load a variable file based on the OS type, or a default if not found.
  ansible.builtin.include_vars: "{{ item }}"
  with_first_found:
    - "{{ ansible_distribution }}-{{ ansible_distribution_version }}.yaml"
    - "{{ ansible_distribution }}.yaml"
    - "{{ ansible_os_family }}.yaml"
    - "default.yaml"

- name: Load Raspberry Pi OS variables.
  ansible.builtin.include_vars: "raspberry-pi-os.yaml"
  when: is_raspberry_pi

- name: Register facts based on the OS type, or a default if not found
  ansible.builtin.include_tasks:
    file: "{{ item }}"
  with_first_found:
    - "register-{{ ansible_distribution }}-{{ ansible_distribution_version }}-facts.yaml"
    - "register-{{ ansible_distribution }}-facts.yaml"
    - "register-{{ ansible_os_family }}-facts.yaml"
    - "register-default-facts.yaml"

- name: Register custom facts
  ansible.builtin.include_tasks:
    apply:
      vars:
        fact_category: "{{ item.fact_category }}"
        fact_configuration_directories_to_copy: "{{ item.fact_configuration_directories_to_copy | default([]) }}"
        fact_configuration_directories_to_create: "{{ item.fact_configuration_directories_to_create | default([]) }}"
        fact_os_package_repositories_to_add: "{{ item.fact_os_package_repositories_to_add | default([]) }}"
        fact_os_packages_to_install: "{{ item.fact_os_packages_to_install | default([]) }}"
        fact_os_packages_to_uninstall: "{{ item.fact_os_packages_to_uninstall | default([]) }}"
        fact_os_services_to_configure: "{{ item.fact_os_services_to_configure | default([]) }}"
        fact_templates_to_render: "{{ item.fact_templates_to_render | default([]) }}"
    file: register-custom-facts.yaml
  with_items:
    - fact_category: "Raspberry Pi Sense Hat"
      fact_configuration_directories_to_copy: "{{ sense_hat_exporter_configuration_directories_to_copy }}"
      fact_configuration_directories_to_create: "{{ sense_hat_exporter_configuration_directories }}"
      fact_os_packages_to_install: "{{ raspberry_pi_sense_hat_apt_packages }}"
      fact_os_services_to_configure: "{{ sense_hat_os_services_to_configure }}"
      fact_templates_to_render: "{{ sense_hat_templates_to_render }}"
    - fact_category: "ssh"
      fact_os_services_to_configure: "{{ ssh_os_services_to_configure }}"

- name: Include Raspberry Pi Sense Hat tasks
  ansible.builtin.include_tasks:
    file: register-raspberry-pi-sense-hat-facts.yaml
  when: has_sense_hat

- name: Include Docker tasks
  ansible.builtin.include_tasks:
    file: register-docker-facts.yaml
  when: configure_docker

- name: Include fail2ban tasks
  ansible.builtin.include_tasks:
    file: register-fail2ban-facts.yaml
  when: security_fail2ban_enabled

- name: Include unattended-upgrades tasks
  ansible.builtin.include_tasks:
    file: register-unattended-upgrades-facts.yaml
  when: security_unattended_upgrades_enabled

- name: Include monitoring tasks
  ansible.builtin.include_tasks:
    file: register-monitoring-facts.yaml
  when: configure_monitoring

- name: Include monitoring backend tasks
  ansible.builtin.include_tasks:
    file: register-monitoring-backend-facts.yaml
  when: configure_monitoring_backend
...
