---
- name: Setup variables
  ansible.builtin.import_tasks: include-variables.yaml
  tags:
    - always

- name: Eventually stop processes and services before cleaning up data and configuration
  ansible.builtin.import_tasks: stop-services-and-processes.yaml
  become: true

- name: Set the ownership of system-wide configuration directories
  ansible.builtin.file:
    group: root
    mode: "0755"
    owner: root
    path: "{{ item }}"
  become: true
  with_items: "{{ directories_to_ensure_ownership }}"

- name: Configure directories
  ansible.builtin.file:
    group: "{{ item.group | default('root') }}"
    mode: "{{ item.mode | default('0755') }}"
    owner: "{{ item.owner | default('root') }}"
    path: "{{ item.path }}"
    state: "{{ item.state }}"
  become: true
  with_items: "{{ configuration_directories }}"

- name: Copy system-wide, templated configuration files in place
  ansible.builtin.template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    force: "{{ item.force | default(omit) }}"
    owner: "{{ item.owner | default('root') }}"
    group: "{{ item.group | default('root') }}"
    mode: "{{ item.mode | default('0644') }}"
  become: true
  register: system_wide_rendered_templates
  when:
    - item.state == 'file'
  tags:
    - templates
  with_items: "{{ templates_to_render }}"

- name: Download files
  become: true
  ansible.builtin.get_url:
    url: "{{ item.url }}"
    dest: "{{ item.dest }}"
    mode: "{{ item.mode }}"
    owner: "{{ item.owner }}"
    group: "{{ item.group }}"
  register: system_wide_downloaded_files
  when:
    - item.state == 'file'
  with_items: "{{ files_to_download }}"

- name: Copy configuration files
  ansible.builtin.copy:
    src: "{{ item.src }}"
    dest: "{{ item.path | default(item.dest) }}"
    group: "{{ item.group | default('root') }}"
    mode: "{{ item.mode | default('0644') }}"
    owner: "{{ item.owner | default('root') }}"
  become: true
  register: copied_configuration_files
  when:
    - item.state == 'file'
  with_items: "{{ files_to_configure }}"
  tags:
    - configuration_files

- name: Delete files marked for deletion
  ansible.builtin.file:
    path: "{{ item.path | default(item.dest) }}"
    state: "{{ item.state }}"
  become: true
  register: configured_files_and_directories_result
  when:
    - item.state == 'absent'
  with_items: "{{ files_to_configure }}"
  tags:
    - configuration_directories
    - configuration_files

- name: Include users setup tasks
  ansible.builtin.import_tasks: users.yaml
  become: true
  tags:
    - os_users

- name: Create Samba share directories
  ansible.builtin.file:
    group: "{{ item.directory_group }}"
    mode: "{{ item.directory_mask }}"
    owner: "{{ item.directory_owner }}"
    path: "{{ item.path }}"
    state: directory
  become: true
  with_items: "{{ samba_shares }}"

- name: Import Debian tasks
  ansible.builtin.import_tasks: setup-Debian.yaml
  when: ansible_facts.os_family == 'Debian'

- name: Import Systemd tasks
  ansible.builtin.import_tasks: setup-systemd.yaml
  become: true

- name: Import SSH tasks
  ansible.builtin.import_tasks: ssh.yaml
  become: true

- name: Import Raspberry Pi tasks
  ansible.builtin.import_tasks: setup-raspberry-pi.yaml
  when: is_raspberry_pi

- name: Import OS services tasks
  ansible.builtin.import_tasks: os-services.yaml
  become: true
  tags:
    - os_services

- name: Import disk setup tasks
  ansible.builtin.import_tasks: setup-disks.yaml
  become: true

- name: Import Argon One case tasks
  ansible.builtin.import_tasks: setup-argonone-case.yaml
  become: true
  when: has_argonone_case

- name: Import Cron Job tasks
  ansible.builtin.import_tasks: setup-cron.yaml

- name: Run system-wide configuration handlers
  ansible.builtin.import_tasks: invoke-system-wide-configuration-handlers.yaml
  become: true
...
