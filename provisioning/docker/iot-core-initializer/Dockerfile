FROM alpine:3.12

RUN apk add --no-cache --update \
    curl \
    openssl

ARG IOT_CORE_CONFIGURATION_DIRECTORY_PATH="/etc/cloud-iot-core"
ENV IOT_CORE_CONFIGURATION_DIRECTORY_PATH="${IOT_CORE_CONFIGURATION_DIRECTORY_PATH}"
ENV IOT_CORE_CERTIFICATES_DIRECTORY_PATH="${IOT_CORE_CONFIGURATION_DIRECTORY_PATH}/certificates" \
    IOT_CORE_KEYS_DIRECTORY_PATH="${IOT_CORE_CONFIGURATION_DIRECTORY_PATH}/keys"
ENV IOT_CORE_ROOT_CA_PATH="${IOT_CORE_CERTIFICATES_DIRECTORY_PATH}/iot-core-root-ca.pem" \
    IOT_CORE_KEYS_PRIVATE_KEY_PATH="${IOT_CORE_KEYS_DIRECTORY_PATH}/private_key.pem" \
    IOT_CORE_KEYS_PUBLIC_KEY_PATH="${IOT_CORE_KEYS_DIRECTORY_PATH}/public_key.pem"

ARG IOT_CORE_ROOT_CA_URL="https://pki.goog/roots.pem"
ENV IOT_CORE_ROOT_CA_URL="${IOT_CORE_ROOT_CA_URL}"

ARG CONFIGURATION_DIRECTORY_PATH
COPY "$CONFIGURATION_DIRECTORY_PATH"/ /

VOLUME ["${IOT_CORE_CONFIGURATION_DIRECTORY_PATH}"]

RUN chmod a+x /docker-entrypoint.sh
ENTRYPOINT ["/docker-entrypoint.sh"]
