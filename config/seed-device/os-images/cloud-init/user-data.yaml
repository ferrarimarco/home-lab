#cloud-config
# This file is autogenerated from a template. Don't apply changes manually.
---

# Set the password to a known value, and expire it right after the first login,
# so that the user is forced to change it.
chpasswd:
  expire: true
  list:
    - "marco:marco"

groups:
  - microk8s

hostname: home-lab-1

locale: en_US.UTF-8

# Update the contents of /etc/hosts based on the hostname/fqdn specified
manage_etc_hosts: true

# Set up the NTP client with default configuration and client
ntp:
  enabled: true
  ntp_client: auto

packages:
  - openssh-server

package_update: true
package_upgrade: true
package_reboot_if_required: true

keyboard:
  layout: us

random_seed:
  file: /dev/urandom
  command: ["pollinate", "-r", "-s", "https://entropy.ubuntu.com"]
  command_required: true

resize_rootfs: true

# We don't use a script because Ubuntu autoinstall doesn't support generating
# a user-data file that includes scripts that are not in autoinstall.user-data
runcmd:
  - /snap/bin/microk8s status --wait-ready
  - /snap/bin/microk8s enable dashboard dns gpu ingress storage
  - /snap/bin/microk8s status --wait-ready

snap:
  commands:
    "1": "snap install microk8s --classic --channel=1.23/stable"

# Enable SSH password authentication. We use for the first authentication,
# then we switch to key-based authentication later in the setup process.
ssh_pwauth: true

# Remove default host keys if any
ssh_deletekeys: true

timezone: Etc/UTC

# Create users and don't preserve the default user,
# so that we've full control on which accounts we expect to be there.
users:
  - name: marco
    gecos: Marco
    groups: [adm, audio, cdrom, dialout, dip, floppy, lxd, microk8s, netdev, plugdev, sudo, video]
    # Don't lock the user to allow the first login with a password,
    # so that we initialize key-based authentication later.
    lock_passwd: false
    shell: /usr/bin/bash
    sudo: ["ALL=(ALL) NOPASSWD:ALL"]
...
