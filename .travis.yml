---
dist: bionic
language: shell
os: linux
services:
  - docker
stages:
  - linting
env:
  global:
    - CMAKE_VERSION="3.17.3"
jobs:
  fast_finish: true
  include:
    - name: "Linting"
      stage: linting
      language: shell
      cache:
        directories:
          - $HOME/.cache/pip
          - $GEM_HOME
          - vendor/bundle
          - $GOPATH/pkg/mod
          - $HOME/.nvm/versions
      install:
        - sudo scripts/linux/ci/install-dependencies.sh "$CMAKE_VERSION"
        - sudo update-alternatives --install /usr/bin/python python /usr/bin/python3 10
        - scripts/linux/ci/install-node.sh
        - nvm use
        - scripts/linux/ci/install-linting-tools.sh
      script: |
        scripts/linux/ci/lint.sh || exit 1
    - name: "Build Smart Desk"
      stage: build
      language: shell
      cache:
        directories:
          - $HOME/.cache/pip
          - $GEM_HOME
          - vendor/bundle
          - $GOPATH/pkg/mod
          - $HOME/.nvm/versions
          - $HOME/.esp-idf
          - $HOME/.espressif/dist
          - $HOME/.espressif/tools
      before_install:
        - |
          sudo \
          PATH="$HOME/cmake-$CMAKE_VERSION-Linux-x86_64/bin:$PATH" \
          scripts/linux/ci/install-dependencies.sh "$CMAKE_VERSION"
      install:
        - |
          sudo \
          PATH="$HOME/cmake-$CMAKE_VERSION-Linux-x86_64/bin:$PATH" \
          scripts/linux/ci/initialize-esp-idf.sh "$HOME/.esp-idf"
      script: |
        PATH="$HOME/cmake-$CMAKE_VERSION-Linux-x86_64/bin:$PATH";
        . "$HOME"/.esp-idf/export.sh;
        cd "$TRAVIS_BUILD_DIR"/provisioning/esp32/smart_desk && idf.py build;
        cd "$TRAVIS_BUILD_DIR"/provisioning/esp32/smart_desk/test && idf.py build;
      after_failure:
        - |
          scripts/linux/ci/diagnostics.sh --host
